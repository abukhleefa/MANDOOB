<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø³Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨</title>
  <style>
    body { font-family: Arial; direction: rtl; padding: 20px; background: #f4f4f4; }
    input, button, textarea, select { width: 100%; margin: 5px 0; padding: 10px; }
    #result, #map, #mapRoute { margin-top: 20px; background: #fff; padding: 10px; border: 1px solid #ccc; }
    #map, #mapRoute { height: 300px; display: none; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATWZuTJWIPaykO5yYfblGVxmAiMenefg8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Ø£Ø¯Ø®Ù„ Ø±ÙˆØ§Ø¨Ø· Google Maps (Ø­ØªÙ‰ 10 Ù…ÙˆØ§Ù‚Ø¹)</h2>
  <div id="links">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 1">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 2">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 3">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 4">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 5">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 6">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 7">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 8">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 9">
    <input type="text" placeholder="Ø±Ø§Ø¨Ø· 10">
  </div>

  <h3>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</h3>
  <label><input type="radio" name="startOption" value="current" checked> Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</label><br>
  <label><input type="radio" name="startOption" value="manual"> Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ (Ø±Ø§Ø¨Ø· Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©)</label><br>
  <input type="text" id="manualStart" placeholder="Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" disabled>
  <button onclick="toggleMap()">ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
  <div id="map"></div>

  <h3>ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙ†Ù‚Ù„</h3>
  <select id="travelMode">
    <option value="DRIVING">ğŸš— Ù‚ÙŠØ§Ø¯Ø©</option>
    <option value="WALKING">ğŸš¶â€â™‚ï¸ Ù…Ø´ÙŠ</option>
    <option value="BICYCLING">ğŸš´â€â™€ï¸ Ø¯Ø±Ø§Ø¬Ø©</option>
  </select>

  <h3>Ø£Ùˆ Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ù† Excel:</h3>
  <input type="file" id="excelFile" accept=".xlsx" />
  <div id="excelStatus" style="color: green; font-weight: bold; margin-top: 10px;"></div>

  <button onclick="startProcessing()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±</button>
  <div id="result"></div>
  <div id="mapRoute"></div>

<script>
let manualStartCoord = null;
let map, marker, routeMap, directionsRenderer;

function toggleMap() {
  const mapDiv = document.getElementById("map");
  mapDiv.style.display = "block";
  if (!map) {
    map = new google.maps.Map(mapDiv, {
      center: { lat: 24.7136, lng: 46.6753 },
      zoom: 6
    });
    manualStartCoord = { lat: 24.7136, lng: 46.6753 };
    marker = new google.maps.Marker({
      position: manualStartCoord,
      map: map,
      draggable: true
    });
    marker.addListener("dragend", function (e) {
      manualStartCoord = {
        lat: e.latLng.lat(),
        lng: e.latLng.lng()
      };
    });
  }
}

document.querySelectorAll('input[name="startOption"]').forEach(r => {
  r.addEventListener('change', () => {
    const isManual = document.querySelector('input[name="startOption"]:checked').value === 'manual';
    document.getElementById("manualStart").disabled = !isManual;
  });
});

async function getLatLngFromURL(url) {
  const directRegex = /@(\-?\d+\.\d+),(\-?\d+\.\d+)/;
  const match = url.match(directRegex);
  if (match) {
    return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
  }

  if (url.includes("maps.app.goo.gl")) {
    try {
      const response = await fetch(`https://shortlink-resolver.onrender.com/resolve?url=${encodeURIComponent(url)}`);
      const data = await response.json();
      if (data.resolvedUrl) {
        return getLatLngFromURL(data.resolvedUrl);
      }
    } catch (e) {
      return null;
    }
  }

  const coordRegex = /search\/(\-?\d+\.\d+),(\-?\d+\.\d+)/;
  const match2 = url.match(coordRegex);
  if (match2) {
    return { lat: parseFloat(match2[1]), lng: parseFloat(match2[2]) };
  }

  return null;
}

function calculateDistance(a, b) {
  const toRad = deg => deg * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const a1 = Math.sin(dLat / 2) ** 2 + Math.sin(dLng / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
  const c = 2 * Math.atan2(Math.sqrt(a1), Math.sqrt(1 - a1));
  return R * c;
}

function saveInputs() {
  const urls = Array.from(document.querySelectorAll("#links input")).map(i => i.value);
  const manualStart = document.getElementById("manualStart").value;
  const mode = document.getElementById("travelMode").value;
  localStorage.setItem("urls", JSON.stringify(urls));
  localStorage.setItem("manualStart", manualStart);
  localStorage.setItem("travelMode", mode);
}

function loadInputs() {
  const urls = JSON.parse(localStorage.getItem("urls") || "[]");
  const manualStart = localStorage.getItem("manualStart") || "";
  const mode = localStorage.getItem("travelMode") || "DRIVING";
  const inputs = document.querySelectorAll("#links input");
  inputs.forEach((input, i) => input.value = urls[i] || "");
  document.getElementById("manualStart").value = manualStart;
  document.getElementById("travelMode").value = mode;
}

document.querySelectorAll("#links input, #manualStart, #travelMode").forEach(el => {
  el.addEventListener("input", saveInputs);
});

document.getElementById("excelFile").addEventListener("change", function (e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const urls = rows.flat().filter(cell => typeof cell === "string" && cell.includes("maps"));
    const inputs = document.querySelectorAll("#links input");
    inputs.forEach((input, i) => input.value = urls[i] || "");
    saveInputs();
    document.getElementById("excelStatus").innerText = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Excel Ø¨Ù†Ø¬Ø§Ø­!";
    setTimeout(() => { document.getElementById("excelStatus").innerText = ""; }, 3000);
  };
  reader.readAsArrayBuffer(file);
});

async function startProcessing() {
  const inputs = Array.from(document.querySelectorAll('#links input'));
  const urls = inputs.map(input => input.value.trim()).filter(url => url);
  const resultDiv = document.getElementById('result');
  const startOption = document.querySelector('input[name="startOption"]:checked').value;
  const travelMode = document.getElementById("travelMode").value;

  if (urls.length < 2) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
    return;
  }

  resultDiv.innerText = "Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...";

  const locations = [];
  for (let url of urls) {
    const coords = await getLatLngFromURL(url);
    if (coords) locations.push(coords);
  }

  if (locations.length < 2) {
    resultDiv.innerText = "ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·.";
    return;
  }

  let origin = null;

  if (startOption === 'current') {
    await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(pos => {
        origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        resolve();
      }, err => {
        resultDiv.innerText = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ: " + err.message;
        reject();
      });
    });
  } else {
    const link = document.getElementById("manualStart").value.trim();
    if (link) {
      origin = await getLatLngFromURL(link);
      if (!origin) {
        alert("ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.");
        return;
      }
    } else if (manualStartCoord) {
      origin = manualStartCoord;
    } else {
      alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
      return;
    }
  }

  locations.sort((a, b) => calculateDistance(origin, a) - calculateDistance(origin, b));
  const destination = locations[locations.length - 1];
  const waypoints = locations.slice(0, -1).map(loc => ({ location: loc, stopover: true }));

  const directionsService = new google.maps.DirectionsService();
  const request = {
    origin: origin,
    destination: destination,
    travelMode: travelMode,
    waypoints: waypoints
  };

  directionsService.route(request, function(result, status) {
    if (status === 'OK') {
      const mapDiv = document.getElementById('mapRoute');
      mapDiv.style.display = 'block';
      if (!routeMap) {
        routeMap = new google.maps.Map(mapDiv, { zoom: 6, center: origin });
        directionsRenderer = new google.maps.DirectionsRenderer({ map: routeMap });
      }
      directionsRenderer.setDirections(result);

      const originStr = `${origin.lat},${origin.lng}`;
      const destinationStr = `${destination.lat},${destination.lng}`;
      const waypointsStr = locations.slice(1, -1).map(loc => `${loc.lat},${loc.lng}`).join("|");

      const mapLink = `https://www.google.com/maps/dir/?api=1&origin=${originStr}&destination=${destinationStr}&travelmode=${travelMode.toLowerCase()}&waypoints=${waypointsStr}`;

      resultDiv.innerHTML = `
        <p><strong>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±!</strong></p>
        <a href="${mapLink}" target="_blank">ğŸ”— Ø§ÙØªØ­ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Google Maps</a><br><br>
        <textarea rows="3" style="width:100%;">${mapLink}</textarea><br><br>
        <a href="https://wa.me/?text=${encodeURIComponent(mapLink)}" target="_blank">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ WhatsApp</a><br>
        <a href="mailto:?subject=Ø§Ù„Ù…Ø³Ø§Ø±&body=${encodeURIComponent(mapLink)}">ğŸ“§ Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</a>
      `;
    } else {
      resultDiv.innerText = "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±. Ø§Ù„Ø­Ø§Ù„Ø©: " + status;
    }
  });
}

loadInputs();
</script>
</body>
</html>
