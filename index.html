<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø³Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆØ¬Ù‡Ø§Øª</title>
  <style>
    body {
      font-family: Arial;
      direction: rtl;
      padding: 20px;
      background: #f4f4f4;
    }
    input, button, textarea, select {
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      box-sizing: border-box;
    }
    #result, #mapRoute {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
    }
    #mapRoute {
      height: 400px;
      display: none;
      position: relative;
    }
    .location-input {
      display: flex;
      gap: 5px;
      margin-bottom: 8px;
    }
    .location-input input[type="text"]:first-child {
      flex: 3;
    }
    .location-input input[type="text"]:last-child {
      flex: 2;
    }
    .marker-label {
      color: #604C78;
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
      position: absolute;
      transform: translate(10px, -15px);
      pointer-events: none;
      user-select: none;
      font-family: Arial, sans-serif;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATWZuTJWIPaykO5yYfblGVxmAiMenefg8"></script>
</head>
<body>
  <h2>Ø£Ø¯Ø®Ù„ Ø±ÙˆØ§Ø¨Ø· Google Maps ÙˆØ£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆØ¬Ù‡Ø§Øª (Ø­ØªÙ‰ 10 Ù…ÙˆØ§Ù‚Ø¹)</h2>

  <div id="links">
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 1" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 1" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 2" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 2" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 3" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 3" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 4" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 4" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 5" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 5" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 6" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 6" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 7" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 7" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 8" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 8" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 9" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 9" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ 10" />
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ 10" />
    </div>
  </div>

  <h3>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</h3>
  <label><input type="radio" name="startOption" value="current" checked /> Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</label><br />
  <label><input type="radio" name="startOption" value="manual" /> Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ (Ø±Ø§Ø¨Ø· Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©)</label><br />
  <input type="text" id="manualStart" placeholder="Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" disabled />
  <button onclick="toggleMap()">ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
  <div id="map" style="height: 300px; margin-top: 10px; display:none;"></div>

  <h3>ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙ†Ù‚Ù„</h3>
  <select id="travelMode">
    <option value="DRIVING">ğŸš— Ù‚ÙŠØ§Ø¯Ø©</option>
    <option value="WALKING">ğŸš¶â€â™‚ï¸ Ù…Ø´ÙŠ</option>
    <option value="BICYCLING">ğŸš´â€â™€ï¸ Ø¯Ø±Ø§Ø¬Ø©</option>
  </select>

  <button onclick="startProcessing()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±</button>
  <div id="result"></div>
  <div id="mapRoute"></div>

  <script>
    let manualStartCoord = null;
    let map, marker, routeMap, directionsRenderer;
    let markerLabels = [];

    function toggleMap() {
      const mapDiv = document.getElementById("map");
      if (mapDiv.style.display === "none") {
        mapDiv.style.display = "block";
        if (!map) {
          map = new google.maps.Map(mapDiv, {
            center: { lat: 24.7136, lng: 46.6753 },
            zoom: 6,
          });
          manualStartCoord = { lat: 24.7136, lng: 46.6753 };
          marker = new google.maps.Marker({
            position: manualStartCoord,
            map: map,
            draggable: true,
          });
          marker.addListener("dragend", function (e) {
            manualStartCoord = {
              lat: e.latLng.lat(),
              lng: e.latLng.lng(),
            };
          });
        }
      } else {
        mapDiv.style.display = "none";
      }
    }

    document.querySelectorAll('input[name="startOption"]').forEach((r) => {
      r.addEventListener("change", () => {
        const isManual =
          document.querySelector('input[name="startOption"]:checked').value ===
          "manual";
        document.getElementById("manualStart").disabled = !isManual;
        if (!isManual) {
          document.getElementById("map").style.display = "none";
        }
      });
    });

    function getLatLngFromURL(url) {
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
      const regexAt = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
      const matchAt = url.match(regexAt);
      if (matchAt) {
        return { lat: parseFloat(matchAt[1]), lng: parseFloat(matchAt[2]) };
      }
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù…Ø«Ù„: https://www.google.com/maps/search/lat,lng
      const regexSearch = /maps\/search\/(-?\d+\.\d+),(-?\d+\.\d+)/;
      const matchSearch = url.match(regexSearch);
      if (matchSearch) {
        return { lat: parseFloat(matchSearch[1]), lng: parseFloat(matchSearch[2]) };
      }
      return null;
    }

    function calculateDistance(a, b) {
      const toRad = (deg) => (deg * Math.PI) / 180;
      const R = 6371;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const a1 =
        Math.sin(dLat / 2) ** 2 +
        Math.sin(dLng / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a1), Math.sqrt(1 - a1));
      return R * c;
    }

    function clearMarkers() {
      markerLabels.forEach((obj) => {
        obj.marker.setMap(null);
        if (obj.labelDiv) obj.labelDiv.remove();
      });
      markerLabels = [];
    }

    async function startProcessing() {
      clearMarkers();
      const inputs = Array.from(
        document.querySelectorAll("#links .location-input")
      );
      const locations = [];
      const names = [];

      for (const div of inputs) {
        const url = div.querySelector("input[type=text]").value.trim();
        const name = div.querySelectorAll("input[type=text]")[1].value.trim();
        if (url) {
          const coords = getLatLngFromURL(url);
          if (coords) {
            locations.push(coords);
            names.push(name || "Ù…ÙˆÙ‚Ø¹");
          }
        }
      }

      const resultDiv = document.getElementById("result");
      resultDiv.innerText = "";

      if (locations.length < 2) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· ØµØ­ÙŠØ­Ø©.");
        return;
      }

      const startOption = document.querySelector(
        'input[name="startOption"]:checked'
      ).value;
      let origin = null;

      if (startOption === "current") {
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
          origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        } catch (err) {
          alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ: " + err.message);
          return;
        }
      } else {
        const manualURL = document.getElementById("manualStart").value.trim();
        if (manualURL) {
          const manualCoord = getLatLngFromURL(manualURL);
          if (!manualCoord) {
            alert("Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­.");
            return;
          }
          origin = manualCoord;
        } else if (manualStartCoord) {
          origin = manualStartCoord;
        } else {
          alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ø§ÙŠØ© ØµØ­ÙŠØ­.");
          return;
        }
      }

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
      locations.sort((a, b) => {
        return calculateDistance(origin, a) - calculateDistance(origin, b);
      });

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø±ØªØ¨Ø©
      let listText = "ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨:\n";
      for (let i = 0; i < locations.length; i++) {
        listText += `${i + 1}. ${names[i]} - (${locations[i].lat.toFixed(
          5
        )}, ${locations[i].lng.toFixed(5)})\n`;
      }
      resultDiv.innerText = listText;

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      showRouteOnMap(origin, locations, names);
    }

    function showRouteOnMap(origin, destinations, names) {
      if (!routeMap) {
        routeMap = new google.maps.Map(document.getElementById("mapRoute"), {
          zoom: 7,
          center: origin,
        });
        directionsRenderer = new google.maps.DirectionsRenderer({
          suppressMarkers: true,
          preserveViewport: true,
        });
        directionsRenderer.setMap(routeMap);
      }

      document.getElementById("mapRoute").style.display = "block";

      // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
      clearMarkers();

      // Ù†Ø¶Ø¹ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø¹Ù„Ø§Ù…Ø© Ø²Ø±Ù‚Ø§Ø¡
      const originMarker = new google.maps.Marker({
        position: origin,
        map: routeMap,
        icon: {
          url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        },
      });

      // Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©)
      addLabelToMarker(originMarker, "Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", origin);

      // Ù†Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ÙˆØ¬Ù‡Ø§Øª ÙˆØ£Ø³Ù…Ø§Ø¦Ù‡Ø§
      for (let i = 0; i < destinations.length; i++) {
        const dest = destinations[i];
        const name = names[i] || "Ù…ÙˆÙ‚Ø¹";

        // Ø¹Ù„Ø§Ù…Ø© Ø­Ù…Ø±Ø§Ø¡
        const marker = new google.maps.Marker({
          position: dest,
          map: routeMap,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
          },
        });

        addLabelToMarker(marker, name, dest);
        markerLabels.push({ marker });
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø± Ù…Ø¹ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‚Ø§Ø·
      const waypoints = destinations.slice(1).map((loc) => ({
        location: loc,
        stopover: true,
      }));

      const directionsService = new google.maps.DirectionsService();

      directionsService.route(
        {
          origin: origin,
          destination: destinations[destinations.length - 1],
          waypoints: waypoints,
          travelMode: document.getElementById("travelMode").value,
          optimizeWaypoints: false,
        },
        (response, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(response);
          } else {
            alert("ÙØ´Ù„ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±: " + status);
          }
        }
      );
    }

    function addLabelToMarker(marker, labelText, position) {
      const mapDiv = document.getElementById("mapRoute");

      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ù†Øµ Ù„Ù„Ø¹Ù„Ø§Ù…Ø©
      const labelDiv = document.createElement("div");
      labelDiv.className = "marker-label";
      labelDiv.style.position = "absolute";
      labelDiv.innerText = labelText;
      mapDiv.appendChild(labelDiv);

      // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      function updatePosition() {
        const point = routeMap.getProjection().fromLatLngToPoint(marker.getPosition());
        const scale = Math.pow(2, routeMap.getZoom());
        const worldCoordinate = routeMap.getProjection().fromLatLngToPoint(marker.getPosition());
        const pixelCoordinate = new google.maps.Point(
          worldCoordinate.x * scale,
          worldCoordinate.y * scale
        );

        labelDiv.style.left = pixelCoordinate.x + 15 + "px"; // 15px ÙŠÙ…ÙŠÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        labelDiv.style.top = pixelCoordinate.y - 15 + "px";  // 15px ÙÙˆÙ‚ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
      }

      // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙƒØ¨ÙŠØ±
      routeMap.addListener("bounds_changed", () => {
        updatePosition();
      });

      // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      setTimeout(updatePosition, 500);

      markerLabels.push({ marker, labelDiv });
    }
  </script>
</body>
</html>
