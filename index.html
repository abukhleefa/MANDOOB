<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>مسار حسب القرب مع أسماء الوجهات</title>
  <style>
    body {
      font-family: Arial;
      direction: rtl;
      padding: 20px;
      background: #f4f4f4;
    }
    input, button, textarea, select {
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      box-sizing: border-box;
    }
    #result, #mapRoute {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
    }
    #mapRoute {
      height: 400px;
      display: none;
      position: relative;
    }
    .location-input {
      display: flex;
      gap: 5px;
      margin-bottom: 8px;
    }
    .location-input input[type="text"]:first-child {
      flex: 3;
    }
    .location-input input[type="text"]:last-child {
      flex: 2;
    }
    .marker-label {
      color: #604C78;
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
      position: absolute;
      transform: translate(10px, -15px);
      pointer-events: none;
      user-select: none;
      font-family: Arial, sans-serif;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATWZuTJWIPaykO5yYfblGVxmAiMenefg8"></script>
</head>
<body>
  <h2>أدخل روابط Google Maps وأسماء الوجهات (حتى 10 مواقع)</h2>

  <div id="links">
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 1" />
      <input type="text" placeholder="اسم الموقع 1" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 2" />
      <input type="text" placeholder="اسم الموقع 2" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 3" />
      <input type="text" placeholder="اسم الموقع 3" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 4" />
      <input type="text" placeholder="اسم الموقع 4" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 5" />
      <input type="text" placeholder="اسم الموقع 5" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 6" />
      <input type="text" placeholder="اسم الموقع 6" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 7" />
      <input type="text" placeholder="اسم الموقع 7" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 8" />
      <input type="text" placeholder="اسم الموقع 8" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 9" />
      <input type="text" placeholder="اسم الموقع 9" />
    </div>
    <div class="location-input">
      <input type="text" placeholder="رابط الموقع 10" />
      <input type="text" placeholder="اسم الموقع 10" />
    </div>
  </div>

  <h3>نقطة البداية</h3>
  <label><input type="radio" name="startOption" value="current" checked /> موقعي الحالي (افتراضي)</label><br />
  <label><input type="radio" name="startOption" value="manual" /> موقع مخصص (رابط أو تحديد على الخريطة)</label><br />
  <input type="text" id="manualStart" placeholder="رابط موقع البداية (اختياري)" disabled />
  <button onclick="toggleMap()">تحديد على الخريطة</button>
  <div id="map" style="height: 300px; margin-top: 10px; display:none;"></div>

  <h3>وسيلة التنقل</h3>
  <select id="travelMode">
    <option value="DRIVING">🚗 قيادة</option>
    <option value="WALKING">🚶‍♂️ مشي</option>
    <option value="BICYCLING">🚴‍♀️ دراجة</option>
  </select>

  <button onclick="startProcessing()">إنشاء المسار</button>
  <div id="result"></div>
  <div id="mapRoute"></div>

  <script>
    let manualStartCoord = null;
    let map, marker, routeMap, directionsRenderer;
    let markerLabels = [];

    function toggleMap() {
      const mapDiv = document.getElementById("map");
      if (mapDiv.style.display === "none") {
        mapDiv.style.display = "block";
        if (!map) {
          map = new google.maps.Map(mapDiv, {
            center: { lat: 24.7136, lng: 46.6753 },
            zoom: 6,
          });
          manualStartCoord = { lat: 24.7136, lng: 46.6753 };
          marker = new google.maps.Marker({
            position: manualStartCoord,
            map: map,
            draggable: true,
          });
          marker.addListener("dragend", function (e) {
            manualStartCoord = {
              lat: e.latLng.lat(),
              lng: e.latLng.lng(),
            };
          });
        }
      } else {
        mapDiv.style.display = "none";
      }
    }

    document.querySelectorAll('input[name="startOption"]').forEach((r) => {
      r.addEventListener("change", () => {
        const isManual =
          document.querySelector('input[name="startOption"]:checked').value ===
          "manual";
        document.getElementById("manualStart").disabled = !isManual;
        if (!isManual) {
          document.getElementById("map").style.display = "none";
        }
      });
    });

    function getLatLngFromURL(url) {
      // محاولة استخراج الإحداثيات من الرابط
      const regexAt = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
      const matchAt = url.match(regexAt);
      if (matchAt) {
        return { lat: parseFloat(matchAt[1]), lng: parseFloat(matchAt[2]) };
      }
      // محاولة أخرى من روابط البحث البسيطة مثل: https://www.google.com/maps/search/lat,lng
      const regexSearch = /maps\/search\/(-?\d+\.\d+),(-?\d+\.\d+)/;
      const matchSearch = url.match(regexSearch);
      if (matchSearch) {
        return { lat: parseFloat(matchSearch[1]), lng: parseFloat(matchSearch[2]) };
      }
      return null;
    }

    function calculateDistance(a, b) {
      const toRad = (deg) => (deg * Math.PI) / 180;
      const R = 6371;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const a1 =
        Math.sin(dLat / 2) ** 2 +
        Math.sin(dLng / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a1), Math.sqrt(1 - a1));
      return R * c;
    }

    function clearMarkers() {
      markerLabels.forEach((obj) => {
        obj.marker.setMap(null);
        if (obj.labelDiv) obj.labelDiv.remove();
      });
      markerLabels = [];
    }

    async function startProcessing() {
      clearMarkers();
      const inputs = Array.from(
        document.querySelectorAll("#links .location-input")
      );
      const locations = [];
      const names = [];

      for (const div of inputs) {
        const url = div.querySelector("input[type=text]").value.trim();
        const name = div.querySelectorAll("input[type=text]")[1].value.trim();
        if (url) {
          const coords = getLatLngFromURL(url);
          if (coords) {
            locations.push(coords);
            names.push(name || "موقع");
          }
        }
      }

      const resultDiv = document.getElementById("result");
      resultDiv.innerText = "";

      if (locations.length < 2) {
        alert("يرجى إدخال موقعين على الأقل مع روابط صحيحة.");
        return;
      }

      const startOption = document.querySelector(
        'input[name="startOption"]:checked'
      ).value;
      let origin = null;

      if (startOption === "current") {
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
          origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        } catch (err) {
          alert("تعذر تحديد موقعك: " + err.message);
          return;
        }
      } else {
        const manualURL = document.getElementById("manualStart").value.trim();
        if (manualURL) {
          const manualCoord = getLatLngFromURL(manualURL);
          if (!manualCoord) {
            alert("رابط موقع البداية غير صحيح.");
            return;
          }
          origin = manualCoord;
        } else if (manualStartCoord) {
          origin = manualStartCoord;
        } else {
          alert("يرجى إدخال أو تحديد موقع بداية صحيح.");
          return;
        }
      }

      // ترتيب المواقع حسب المسافة من نقطة البداية
      locations.sort((a, b) => {
        return calculateDistance(origin, a) - calculateDistance(origin, b);
      });

      // عرض المواقع المرتبة
      let listText = "ترتيب المواقع حسب القرب:\n";
      for (let i = 0; i < locations.length; i++) {
        listText += `${i + 1}. ${names[i]} - (${locations[i].lat.toFixed(
          5
        )}, ${locations[i].lng.toFixed(5)})\n`;
      }
      resultDiv.innerText = listText;

      // عرض المسار على الخريطة
      showRouteOnMap(origin, locations, names);
    }

    function showRouteOnMap(origin, destinations, names) {
      if (!routeMap) {
        routeMap = new google.maps.Map(document.getElementById("mapRoute"), {
          zoom: 7,
          center: origin,
        });
        directionsRenderer = new google.maps.DirectionsRenderer({
          suppressMarkers: true,
          preserveViewport: true,
        });
        directionsRenderer.setMap(routeMap);
      }

      document.getElementById("mapRoute").style.display = "block";

      // إزالة علامات سابقة
      clearMarkers();

      // نضع نقطة البداية بعلامة زرقاء
      const originMarker = new google.maps.Marker({
        position: origin,
        map: routeMap,
        icon: {
          url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        },
      });

      // إضافة اسم لنقطة البداية (على يمين العلامة)
      addLabelToMarker(originMarker, "نقطة البداية", origin);

      // نضع علامات الوجهات وأسمائها
      for (let i = 0; i < destinations.length; i++) {
        const dest = destinations[i];
        const name = names[i] || "موقع";

        // علامة حمراء
        const marker = new google.maps.Marker({
          position: dest,
          map: routeMap,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
          },
        });

        addLabelToMarker(marker, name, dest);
        markerLabels.push({ marker });
      }

      // إنشاء مسار مع ترتيب النقاط
      const waypoints = destinations.slice(1).map((loc) => ({
        location: loc,
        stopover: true,
      }));

      const directionsService = new google.maps.DirectionsService();

      directionsService.route(
        {
          origin: origin,
          destination: destinations[destinations.length - 1],
          waypoints: waypoints,
          travelMode: document.getElementById("travelMode").value,
          optimizeWaypoints: false,
        },
        (response, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(response);
          } else {
            alert("فشل في حساب المسار: " + status);
          }
        }
      );
    }

    function addLabelToMarker(marker, labelText, position) {
      const mapDiv = document.getElementById("mapRoute");

      // إنشاء عنصر النص للعلامة
      const labelDiv = document.createElement("div");
      labelDiv.className = "marker-label";
      labelDiv.style.position = "absolute";
      labelDiv.innerText = labelText;
      mapDiv.appendChild(labelDiv);

      // تحديث موضع النص حسب موقع العلامة على الخريطة
      function updatePosition() {
        const point = routeMap.getProjection().fromLatLngToPoint(marker.getPosition());
        const scale = Math.pow(2, routeMap.getZoom());
        const worldCoordinate = routeMap.getProjection().fromLatLngToPoint(marker.getPosition());
        const pixelCoordinate = new google.maps.Point(
          worldCoordinate.x * scale,
          worldCoordinate.y * scale
        );

        labelDiv.style.left = pixelCoordinate.x + 15 + "px"; // 15px يمين العلامة
        labelDiv.style.top = pixelCoordinate.y - 15 + "px";  // 15px فوق العلامة
      }

      // تحديث موضع النص عند تحريك الخريطة أو تغيير التكبير
      routeMap.addListener("bounds_changed", () => {
        updatePosition();
      });

      // التحديث الأولي بعد تحميل الخريطة
      setTimeout(updatePosition, 500);

      markerLabels.push({ marker, labelDiv });
    }
  </script>
</body>
</html>
