<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>منظّم المسار الجغرافي</title>
  <style>
    body { font-family: Arial; direction: rtl; margin: 20px; }
    textarea, input, button { width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
    #map { height: 500px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>منظّم المسار الجغرافي</h2>
  <p>أدخل حتى 10 روابط من خرائط Google تحتوي على الإحداثيات (مثل <code>/search/24.45,54.34</code> أو <code>@24.45,54.34</code>):</p>
  <textarea id="linksInput" rows="10" placeholder="ألصق الروابط هنا..."></textarea>
  <button onclick="processLinks()">إنشاء المسار</button>
  <div id="map"></div>

  <script>
    let map, directionsService, directionsRenderer;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 24.45, lng: 54.39 },
        zoom: 10,
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
    }

    function extractLatLngFromURL(url) {
      let match;

      // 1. /search/lat,lng
      match = url.match(/\/search\/([\d.\-]+),([\d.\-]+)/);
      if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };

      // 2. @lat,lng
      match = url.match(/@([\d.\-]+),([\d.\-]+)/);
      if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };

      // 3. ?q=lat,lng
      match = url.match(/[?&]q=([\d.\-]+),([\d.\-]+)/);
      if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };

      return null;
    }

    async function processLinks() {
      const input = document.getElementById("linksInput").value.trim();
      const urls = input.split("\n").filter(line => line.trim() !== "");

      if (urls.length === 0) {
        alert("يرجى إدخال روابط أولاً.");
        return;
      }

      const coords = [];

      for (const url of urls) {
        const location = extractLatLngFromURL(url);
        if (location) {
          coords.push(location);
        } else {
          alert("تعذر استخراج الإحداثيات من الرابط:\n" + url);
          return;
        }
      }

      if (coords.length < 2) {
        alert("يجب إدخال موقعين على الأقل.");
        return;
      }

      // احصل على الموقع الحالي كنقطة انطلاق
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const origin = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          createRoute(origin, coords);
        },
        () => {
          alert("تعذر الحصول على الموقع الحالي.");
        }
      );
    }

    function createRoute(origin, waypointsCoords) {
      const waypoints = waypointsCoords.slice(0, -1).map(coord => ({
        location: coord,
        stopover: true,
      }));

      directionsService.route(
        {
          origin: origin,
          destination: waypointsCoords[waypointsCoords.length - 1],
          waypoints: waypoints,
          travelMode: google.maps.TravelMode.DRIVING,
          optimizeWaypoints: true,
        },
        (response, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(response);
          } else {
            alert("فشل في إنشاء المسار: " + status);
          }
        }
      );
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATWZuTJWIPaykO5yYfblGVxmAiMenefg8&callback=initMap">
  </script>
</body>
</html>
