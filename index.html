<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ù†Ø¸Ù‘Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
  <style>
    body { font-family: Arial; direction: rtl; margin: 20px; }
    textarea, input, select, button { width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
    #map { height: 500px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Ù…Ù†Ø¸Ù‘Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>

  <label>Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙ†Ù‚Ù„:</label>
  <select id="travelMode">
    <option value="DRIVING">ğŸš— Ø³ÙŠØ§Ø±Ø©</option>
    <option value="WALKING">ğŸš¶â€â™‚ï¸ Ù…Ø´ÙŠ</option>
    <option value="BICYCLING">ğŸš² Ø¯Ø±Ø§Ø¬Ø©</option>
    <option value="TRANSIT">ğŸšŒ Ù…ÙˆØ§ØµÙ„Ø§Øª Ø¹Ø§Ù…Ø©</option>
  </select>

  <label>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ†Ù‚Ø·Ø© Ø§Ù†Ø·Ù„Ø§Ù‚ØŸ</label>
  <select id="startMode">
    <option value="current">Ù†Ø¹Ù…</option>
    <option value="manual">Ù„Ø§ØŒ Ø³Ø£Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</option>
  </select>

  <p>Ø£Ø¯Ø®Ù„ Ø­ØªÙ‰ 10 Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Google ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</p>
  <textarea id="linksInput" rows="10" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‡Ù†Ø§..."></textarea>

  <input type="file" id="excelFile" accept=".xlsx">
  <button onclick="importFromExcel()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</button>

  <button onclick="processLinks()">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±</button>

  <div id="map"></div>
  <button onclick="shareRoute()">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³Ø§Ø±</button>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    let map, directionsService, directionsRenderer, startMarker = null;
    let manualStart = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 24.45, lng: 54.39 },
        zoom: 10,
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

      map.addListener("click", (e) => {
        if (document.getElementById("startMode").value === "manual") {
          if (startMarker) startMarker.setMap(null);
          manualStart = e.latLng;
          startMarker = new google.maps.Marker({
            position: manualStart,
            map: map,
            label: "ğŸš©",
          });
        }
      });
    }

    function extractLatLngFromURL(url) {
      let match;
      match = url.match(/\/search\/([\d.\-]+),([\d.\-]+)/);
      if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
      match = url.match(/@([\d.\-]+),([\d.\-]+)/);
      if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
      match = url.match(/[?&]q=([\d.\-]+),([\d.\-]+)/);
      if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
      return null;
    }

    async function processLinks() {
      const input = document.getElementById("linksInput").value.trim();
      const urls = input.split("\n").filter(line => line.trim() !== "");

      const coords = [];
      for (const url of urls) {
        const location = extractLatLngFromURL(url);
        if (location) coords.push(location);
        else {
          alert("ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·:\n" + url);
          return;
        }
      }
      if (coords.length < 1) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
        return;
      }

      const travelMode = document.getElementById("travelMode").value;
      const startMode = document.getElementById("startMode").value;

      if (startMode === "current") {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const origin = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            createRoute(origin, coords, travelMode);
          },
          () => alert("ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ.")
        );
      } else {
        if (!manualStart) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
        createRoute(manualStart, coords, travelMode);
      }
    }

    function createRoute(origin, waypointsCoords, travelMode) {
      const waypoints = waypointsCoords.map(coord => ({ location: coord, stopover: true }));
      const destination = waypoints.pop().location;
      directionsService.route({
        origin,
        destination,
        waypoints,
        travelMode,
        optimizeWaypoints: true,
      }, (response, status) => {
        if (status === "OK") directionsRenderer.setDirections(response);
        else alert("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±: " + status);
      });
    }

    function shareRoute() {
      const mapUrl = directionsRenderer.getDirections()?.request;
      if (!mapUrl) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹.");
      const mode = document.getElementById("travelMode").value.toLowerCase();
      let origin = mapUrl.origin.lat + "," + mapUrl.origin.lng;
      let destination = mapUrl.destination.lat + "," + mapUrl.destination.lng;
      let waypoints = mapUrl.waypoints.map(wp => wp.location.lat + "," + wp.location.lng).join("/");
      const fullUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=${mode}&waypoints=${waypoints}`;
      const message = `Ø¥Ù„ÙŠÙƒ Ø§Ù„Ù…Ø³Ø§Ø±:\n${fullUrl}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      const mailUrl = `mailto:?subject=Ù…Ø³Ø§Ø± Ø¬ØºØ±Ø§ÙÙŠ&body=${encodeURIComponent(message)}`;
      window.open(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± WhatsAppØŸ") ? whatsappUrl : mailUrl, "_blank");
    }

    function importFromExcel() {
      const fileInput = document.getElementById("excelFile");
      const file = fileInput.files[0];
      if (!file) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const links = XLSX.utils.sheet_to_json(sheet, { header: 1 }).flat().filter(Boolean);
        document.getElementById("linksInput").value = links.join("\n");
        alert("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!");
      };
      reader.readAsArrayBuffer(file);
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATWZuTJWIPaykO5yYfblGVxmAiMenefg8&callback=initMap">
  </script>
</body>
</html>
